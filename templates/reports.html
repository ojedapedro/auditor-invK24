<div class="content-section active" id="reports-section">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Informes de Inventario</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button class="btn btn-sm btn-primary" id="generate-pdf-btn">
                    <i class="fas fa-file-pdf me-1"></i>Generar PDF
                </button>
            </div>
            <div class="btn-group me-2">
                <button class="btn btn-sm btn-success" id="export-csv-btn">
                    <i class="fas fa-file-csv me-1"></i>Exportar CSV
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-chart-bar me-2"></i>Resumen de Incidencias
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="total-items-count">0</h5>
                            <p class="card-text">Total de Items</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="correct-items-count">0</h5>
                            <p class="card-text">Items Correctos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="discrepancy-items-count">0</h5>
                            <p class="card-text">Con Discrepancia</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="missing-items-count">0</h5>
                            <p class="card-text">No Escaneados</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-info" id="accuracy-rate">0%</h5>
                            <p class="card-text">Tasa de Precisión</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-primary" id="completion-rate-report">0%</h5>
                            <p class="card-text">Tasa de Completitud</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped" id="report-table">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Cant. Teórica</th>
                            <th>Cant. Real</th>
                            <th>Diferencia</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Report data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-download me-2"></i>Opciones de Exportación
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="Reports.generatePDF()">
                            <i class="fas fa-file-pdf me-2"></i>Reporte PDF Completo
                        </button>
                        <button class="btn btn-outline-success" onclick="Reports.exportCSV()">
                            <i class="fas fa-file-csv me-2"></i>Datos en CSV
                        </button>
                        <button class="btn btn-outline-info" onclick="exportDiscrepanciesOnly()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Solo Discrepancias
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cogs me-2"></i>Configuración del Reporte
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="include-summary" checked>
                        <label class="form-check-label" for="include-summary">
                            Incluir resumen ejecutivo
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="include-recommendations" checked>
                        <label class="form-check-label" for="include-recommendations">
                            Incluir recomendaciones
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="highlight-discrepancies" checked>
                        <label class="form-check-label" for="highlight-discrepancies">
                            Resaltar discrepancias
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportDiscrepanciesOnly() {
    const theoretical = Inventory.getTheoretical();
    const scanned = Inventory.getScanned();
    
    const discrepancies = [];
    
    // Procesar discrepancias del inventario teórico
    theoretical.forEach(item => {
        const scannedItem = scanned.find(s => s.code === item.code);
        const scannedQty = scannedItem ? scannedItem.scannedQuantity : 0;
        
        if (scannedQty !== item.theoreticalQuantity) {
            const difference = scannedQty - item.theoreticalQuantity;
            discrepancies.push({
                'Código': item.code,
                'Producto': item.name,
                'Cantidad_Teorica': item.theoreticalQuantity,
                'Cantidad_Real': scannedQty,
                'Diferencia': difference,
                'Tipo': scannedQty === 0 ? 'No escaneado' : (difference > 0 ? 'Exceso' : 'Faltante'),
                'Ubicación': 'En inventario teórico'
            });
        }
    });
    
    // Items escaneados que no están en teórico
    scanned.forEach(item => {
        if (!theoretical.find(t => t.code === item.code)) {
            discrepancies.push({
                'Código': item.code,
                'Producto': item.name,
                'Cantidad_Teorica': 0,
                'Cantidad_Real': item.scannedQuantity,
                'Diferencia': item.scannedQuantity,
                'Tipo': 'No en inventario',
                'Ubicación': 'Solo en escaneo'
            });
        }
    });
    
    if (discrepancies.length === 0) {
        Utils.showNotification('No se encontraron discrepancias', 'info');
        return;
    }
    
    const config = Inventory.getConfig();
    const filename = `Discrepancias_${config.store || 'Tienda'}_${config.date || new Date().toISOString().split('T')[0]}.csv`;
    
    Utils.exportToCSV(discrepancies, filename);
    Utils.showNotification('Reporte de discrepancias exportado', 'success');
}

function updateReportStats() {
    const summary = Reports.calculateSummary();
    
    $('#total-items-count').text(summary.totalItems);
    $('#correct-items-count').text(summary.correctItems);
    $('#discrepancy-items-count').text(summary.discrepancyItems);
    $('#missing-items-count').text(summary.missingItems);
    $('#accuracy-rate').text(summary.accuracyRate + '%');
    $('#completion-rate-report').text(summary.completionRate + '%');
    
    // Actualizar cada 3 segundos
    setTimeout(updateReportStats, 3000);
}

// Extender el método calculateSummary para incluir completionRate
Reports.calculateSummary = function() {
    const theoretical = Inventory.getTheoretical();
    const scanned = Inventory.getScanned();
    
    let totalItems = theoretical.length;
    let correctItems = 0;
    let discrepancyItems = 0;
    let missingItems = 0;
    
    theoretical.forEach(item => {
        const scannedItem = scanned.find(s => s.code === item.code);
        const scannedQty = scannedItem ? scannedItem.scannedQuantity : 0;
        
        if (scannedQty === 0) {
            missingItems++;
        } else if (scannedQty === item.theoreticalQuantity) {
            correctItems++;
        } else {
            discrepancyItems++;
        }
    });
    
    // Items escaneados que no están en el teórico
    scanned.forEach(item => {
        if (!theoretical.find(t => t.code === item.code)) {
            totalItems++;
            discrepancyItems++;
        }
    });
    
    const accuracyRate = totalItems > 0 ? Math.round((correctItems / totalItems) * 100) : 0;
    const completionRate = theoretical.length > 0 ? 
        Math.round((scanned.filter(s => theoretical.find(t => t.code === s.code)).length / theoretical.length) * 100) : 0;
    
    return {
        totalItems,
        correctItems,
        discrepancyItems,
        missingItems,
        accuracyRate,
        completionRate
    };
};

// Iniciar actualización cuando se carga la sección
$(document).ready(function() {
    if ($('#reports-section').hasClass('active')) {
        updateReportStats();
        Reports.updateReportTable();
    }
});
</script>